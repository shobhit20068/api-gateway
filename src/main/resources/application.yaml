server:
  port: 8081

spring:
  application:
    name: api-gateway

  data:
    redis:
      host: localhost
      port: 6379

  cloud:
    gateway:
      # -----------------------------
      # Gateway HTTP Client
      # -----------------------------
      httpclient:
        connect-timeout: 3000
        response-timeout: 15s

      # -----------------------------
      # üî• Gateway Metrics (REQUIRED)
      # -----------------------------
      metrics:
        enabled: true

      # -----------------------------
      # Routes
      # -----------------------------
      routes:

        # üîπ Fallback route
        - id: fallback-route
          uri: http://localhost:8081
          predicates:
            - Path=/fallback

        # üîπ Main route
        - id: test-route
          uri: http://httpbin.org
          predicates:
            - Path=/test/**
          filters:
            - RewritePath=/test/(?<segment>.*), /${segment}

            # üîÅ Retry FIRST
            - name: Retry
              args:
                retries: 2
                methods: GET
                statuses:
                  - BAD_GATEWAY
                  - GATEWAY_TIMEOUT
                  - INTERNAL_SERVER_ERROR
                backoff:
                  firstBackoff: 100ms
                  maxBackoff: 500ms
                  factor: 2
                  basedOnPreviousValue: true

            # üõë Circuit Breaker AFTER retry
            - name: CircuitBreaker
              args:
                name: backendService
                fallbackUri: forward:/fallback
                statusCodes:
                  - 500
                  - 502
                  - 503
                  - 504

# -----------------------------
# Resilience4j
# -----------------------------
resilience4j:

  # üö´ Disable TimeLimiter (important for Gateway)
  timelimiter:
    instances:
      backendService:
        timeoutDuration: 60s
        cancelRunningFuture: false

  # ‚úÖ CircuitBreaker config
  circuitbreaker:
    instances:
      backendService:
        slidingWindowType: COUNT_BASED
        slidingWindowSize: 6
        minimumNumberOfCalls: 3
        failureRateThreshold: 50
        waitDurationInOpenState: 30s
        permittedNumberOfCallsInHalfOpenState: 2

        slowCallRateThreshold: 100
        slowCallDurationThreshold: 30s

        recordExceptions:
          - java.io.IOException
          - java.util.concurrent.TimeoutException
          - org.springframework.web.server.ResponseStatusException
          - org.springframework.cloud.gateway.support.TimeoutException

# -----------------------------
# Observability / Actuator
# -----------------------------
management:
  endpoints:
    web:
      # expose all actuator endpoints for testing (switch back to a tighter list for prod)
      exposure:
        include: '*'

  endpoint:
    health:
      show-details: always

  # enable a simple Micrometer registry so /actuator/metrics returns names & values
  metrics:
    export:
      simple:
        enabled: true
    distribution:
      percentiles-histogram:
        spring.cloud.gateway.requests: true
      percentiles:
        spring.cloud.gateway.requests: 0.5,0.9,0.95,0.99

  # keep observations (required for http.client.requests / http.server.requests)
  observations:
    http:
      server:
        enabled: true
      client:
        enabled: true

# -----------------------------
# Logging (Debug / Learning)
# -----------------------------
logging:
  level:
    org.springframework.cloud.gateway.filter.factory.RetryGatewayFilterFactory: TRACE
    org.springframework.cloud.gateway.filter.NettyRoutingFilter: DEBUG
    reactor.netty.http.client: DEBUG
    io.github.resilience4j.circuitbreaker: DEBUG
