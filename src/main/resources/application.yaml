server:
  port: 8081

spring:
  application:
    name: api-gateway

  data:
    redis:
      host: localhost
      port: 6379

  cloud:
    gateway:
      httpclient:
        connect-timeout: 3000
        response-timeout: 15s

      routes:
        # üîπ Fallback route
        - id: fallback-route
          uri: http://localhost:8081
          predicates:
            - Path=/fallback

        # üîπ Main Gateway Route
        - id: test-route
          uri: http://httpbin.org
          predicates:
            - Path=/test/**
          filters:
            - RewritePath=/test/(?<segment>.*), /${segment}

            # üîÅ Retry FIRST
            - name: Retry
              args:
                retries: 2
                methods: GET
                statuses:
                  - BAD_GATEWAY
                  - GATEWAY_TIMEOUT
                  - INTERNAL_SERVER_ERROR
                backoff:
                  firstBackoff: 100ms
                  maxBackoff: 500ms
                  factor: 2
                  basedOnPreviousValue: true

            # üõë Circuit Breaker AFTER retry
            - name: CircuitBreaker
              args:
                name: backendService
                fallbackUri: redirect:/fallback
                statusCodes:
                  - 500
                  - 502
                  - 503
                  - 504

# -----------------------------
# Resilience4j
# -----------------------------
resilience4j:

  # üö´ VERY IMPORTANT ‚Äî DISABLE TimeLimiter
  timelimiter:
    instances:
      backendService:
        timeoutDuration: 60s
        cancelRunningFuture: false

  # ‚úÖ CircuitBreaker = failure tracking ONLY
  circuitbreaker:
    instances:
      backendService:
        slidingWindowType: COUNT_BASED
        slidingWindowSize: 6
        minimumNumberOfCalls: 3
        failureRateThreshold: 50
        waitDurationInOpenState: 30s
        permittedNumberOfCallsInHalfOpenState: 2

        slowCallRateThreshold: 100
        slowCallDurationThreshold: 30s

        ignoreExceptions: []

        recordExceptions:
          - java.io.IOException
          - java.util.concurrent.TimeoutException
          - org.springframework.web.server.ResponseStatusException
          - org.springframework.cloud.gateway.support.TimeoutException

# -----------------------------
# Observability
# -----------------------------
management:
  endpoints:
    web:
      exposure:
        include:
          - health
          - info
          - metrics
          - circuitbreakers
          - circuitbreaker-events

# -----------------------------
# Logging
# -----------------------------
logging:
  level:
    org.springframework.cloud.gateway.filter.factory.RetryGatewayFilterFactory: TRACE
    org.springframework.cloud.gateway.filter.NettyRoutingFilter: DEBUG
    reactor.netty.http.client: DEBUG
    io.github.resilience4j.circuitbreaker: DEBUG
